{"version":3,"names":["POST","stripe","cov_ot4ff5a74","s","_stripe","default","process","env","STRIPE_SECRET_KEY","req","f","event","webhooks","constructEvent","text","headers","get","STRIPE_WEBHOOK_SECRET","type","b","charge","data","object","orderId","metadata","email","billing_details","pricePaidInCents","amount","order","_ordermodel","findById","populate","_server","NextResponse","status","isPaid","paidAt","Date","paymentResult","id","email_address","pricePaid","toFixed","save","_emails","sendPurchaseReceipt","err","console","log","json","message"],"sources":["/home/mark/Downloads/nextjs-amazona-main/app/api/webhooks/stripe/route.tsx"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport Stripe from 'stripe'\n\nimport { sendPurchaseReceipt } from '@/emails'\nimport Order from '@/lib/db/models/order.model'\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY as string)\n\nexport async function POST(req: NextRequest) {\n  const event = await stripe.webhooks.constructEvent(\n    await req.text(),\n    req.headers.get('stripe-signature') as string,\n    process.env.STRIPE_WEBHOOK_SECRET as string\n  )\n\n  if (event.type === 'charge.succeeded') {\n    const charge = event.data.object\n    const orderId = charge.metadata.orderId\n    const email = charge.billing_details.email\n    const pricePaidInCents = charge.amount\n    const order = await Order.findById(orderId).populate('user', 'email')\n    if (order == null) {\n      return new NextResponse('Bad Request', { status: 400 })\n    }\n\n    order.isPaid = true\n    order.paidAt = new Date()\n    order.paymentResult = {\n      id: event.id,\n      status: 'COMPLETED',\n      email_address: email!,\n      pricePaid: (pricePaidInCents / 100).toFixed(2),\n    }\n    await order.save()\n    try {\n      await sendPurchaseReceipt({ order })\n    } catch (err) {\n      console.log('email error', err)\n    }\n    return NextResponse.json({\n      message: 'updateOrderToPaid was successful',\n    })\n  }\n  return new NextResponse()\n}\n"],"mappings":"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","ignoreList":[]}